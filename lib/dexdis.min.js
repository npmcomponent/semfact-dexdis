!function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define("dexdis",[],b):a.Dexdis=b()}(this,function(){var Dexdis,a,b,DexdisTransaction,c,d,e=[].slice,f={}.hasOwnProperty,g=function(a,b){function c(){this.constructor=a}for(var d in b)f.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};return c={transaction:"Operation not allowed during transaction",wrongtype:"Operation against a key holding the wrong kind of value",notsupported:"Operation not supported",toomuchop:"Operation with too much operands"},a=function(){function a(a){var b,c,d,e;for(c=["keys","values"],this._stores={},d=0,e=c.length;e>d;d++)b=c[d],this._stores[b]=a.objectStore(b)}var b;return a.prototype._checkttl=function(a,b){var c,d,e,f;f=this._stores,d=f.keys,e=f.values,c=d.get(a),c.onsuccess=function(){var f,g;return g=c.result,null!=(null!=g?g.expire:void 0)?Date.now()>g.expire?(f=d["delete"](a),f.onsuccess=function(){return b(void 0,!0)},e["delete"](a)):b(g,!1):b(g,!1)}},a.prototype._expiremap=function(a,b,c){var d;d=this._stores.keys,this._checkttl(a,function(e){var f;return void 0!==e?(e.expire=c(e.expire),f=d.put(e,a),f.onsuccess=function(){return b(1)}):b(0)})},a.prototype._getstr=function(a,b){return this.get(a,function(a){var d;if(null!=a){if(d=typeof a,"string"!==d){if("number"!==d)throw new Error(c.wrongtype);a=""+a}}else a="";return b(a)})},a.prototype._map=function(a,b,d){var e,f,g,h,i=this;h=this._stores,e=h.keys,g=h.values,f=null,this._checkttl(a,function(e){var h;return null!=e?"simple"===e.type?(h=g.get(a),h.onsuccess=function(){var c;return f=d(h.result),c=g.put(f,a),c.onsuccess=function(){return b(f)}}):b(new Error(c.wrongtype)):(f=d(null),i.set(a,f,function(){return b(f)}))})},a.prototype._ttlmap=function(a,b,c){this._checkttl(a,function(a){var d;return void 0!==a?(d=-1,null!=a.expire&&(d=a.expire-Date.now(),null!=c&&(d=c(d))),b(d)):b(-2)})},a.prototype.append=function(a,b,c){var d,e;return e=0,d=function(){return c(e)},this._map(a,d,function(a){var c;return c=null!=a?a+b:b,e=c.length,c})},b=function(a){var b,c,d;return b=1431655765,c=858993459,d=252645135,a-=a>>1&b,a=(a&c)+(a>>2&c),a=a+(a>>4)&d,a+=a>>8,a+=a>>16,127&a},a.prototype.bitcount=function(){var a,c,d,f;return c=arguments[0],d=3<=arguments.length?e.call(arguments,1,f=arguments.length-1):(f=1,[]),a=arguments[f++],this._getstr(c,function(c){var e,f;return 2===d.length&&(f=d[0],e=d[1],0>f&&(f=4+f),0>e&&(e=4+e+1),c&=-1>>>32-8*e,c>>>=8*f),a(b(c))})},a.prototype.bitop=function(){var a,b,d,f,g,h,i,j,k,l,m=this;switch(i=arguments[0],b=arguments[1],j=4<=arguments.length?e.call(arguments,2,l=arguments.length-1):(l=2,[]),a=arguments[l++],d=null,g=0,i.toUpperCase()){case"NOT":if(d=function(a,b){return~b},j.length>1)throw new Error(c.toomuchop);break;case"AND":d=function(a,b){return a&b},g=-1;break;case"OR":d=function(a,b){return a|b};break;case"XOR":d=function(a,b){return a^b}}if(null===d)throw new Error(c.notsupported);return k=[],f=0,h=function(c){var e,i;return void 0!==c&&k.push(c),f++,f>j.length?(i=k.reduce(d,g),m.set(b,i,function(){return a((""+i).length)}),void 0):(e=j[f-1],m.get(e,h))},h()},a.prototype.dbsize=function(a){var b,c;return c=this._stores.keys,b=c.count(),b.onsuccess=function(){return a(b.result)}},a.prototype.decr=function(a,b){return this.decrby(a,1,b)},a.prototype.decrby=function(a,b,c){return this.incrby(a,-b,c)},a.prototype.del=function(){var a,b,c,d,f,g,h,i,j,k,l,m;if(c=2<=arguments.length?e.call(arguments,0,i=arguments.length-1):(i=0,[]),a=arguments[i++],l=this._stores,g=l.keys,h=l.values,0===c.length)return a(0),void 0;for(b=0,m=[],d=j=0,k=c.length;k>j;d=++j)f=c[d],m.push(this._checkttl(f,function(e){var i;return null!=e&&(b++,g["delete"](f),i=h["delete"](f),d===c.length)?i.onsuccess=function(){return a(b)}:void 0}));return m},a.prototype.exists=function(a,b){return this._checkttl(a,function(a){return null!=a?b(1):b(0)})},a.prototype.expire=function(a,b,c){return this._expiremap(a,c,function(){return Date.now()+1e3*b})},a.prototype.expireat=function(a,b,c){return this._expiremap(a,c,function(){return 1e3*b})},a.prototype.flushdb=function(a){var b,c,d;d=this._stores,b=d.keys,c=d.values,b.clear(),c.clear(),a("OK")},a.prototype.get=function(a,b){var d,e,f;f=this._stores,d=f.keys,e=f.values,this._checkttl(a,function(d){var f;if(void 0===d)return b(null);if("simple"!==d.type)throw new Error(c.wrongtype);return f=e.get(a),f.onsuccess=function(){return b(f.result)}})},a.prototype.getbit=function(a,b,c){return this._getstr(a,function(a){return b>31?c(0):c(1&a>>>b)})},a.prototype.getrange=function(a,b,c,d){return this._getstr(a,function(a){var e;return e=a.length,0>b&&(b=e+b),0>c&&(c=e+c+1),d(a.substring(b,c))})},a.prototype.getset=function(a,b,c){var d=this;return this.get(a,function(e){return d.set(a,b,function(){return c(e)})})},a.prototype.incr=function(a,b){return this.incrby(a,1,b)},a.prototype.incrby=function(a,b,c){return this._map(a,c,function(a){return a+b})},a.prototype.persist=function(a,b){var c;c=this._stores.keys,this._checkttl(a,function(d){var e,f;return void 0!==d?(f=0,null!=d.expire&&(delete d.expire,f=1),e=c.put(d,a),e.onsuccess=function(){return b(f)}):b(0)})},a.prototype.pexpire=function(a,b,c){return this._expiremap(a,c,function(){return Date.now()+b})},a.prototype.pexpireat=function(a,b,c){return this._expiremap(a,c,function(){return b})},a.prototype.psetex=function(a,b,c,d){var e=this;return this.set(a,c,function(){return e.pexpire(a,b,function(){return d("OK")})})},a.prototype.pttl=function(a,b){return this._ttlmap(a,b)},a.prototype.randomkey=function(a){var b,c;return c=this._stores.keys,b=c.count(),b.onsuccess=function(){var d,e,f;return f=Math.floor(Math.random()*b.result),e=c.openCursor(),d=!1,e.onsuccess=function(){var b;return b=e.result,null!=b?d||0===f?a(b.key):(d=!0,b.advance(f)):void 0}}},a.prototype.set=function(a,b,c){var d,e,f,g,h;h=this._stores,e=h.keys,g=h.values,d={type:"simple"},e.put(d,a),f=g.put(b,a),f.onsuccess=function(){return c("OK")}},a.prototype.setbit=function(a,b,c,d){var e=this;return this._getstr(a,function(f){var g,h;return c&=1,g=1<<b,h=f&~g|c<<b,e.set(a,h,function(){return 0!==(f&g)?d(1):d(0)})})},a.prototype.setex=function(a,b,c,d){var e=this;return this.set(a,c,function(){return e.expire(a,b,function(){return d("OK")})})},a.prototype.setnx=function(a,b,c){var d=this;this._checkttl(a,function(e){return null!=e?c(0):d.set(a,b,function(){return c(1)})})},a.prototype.setrange=function(a,b,c,d){var e=this;return this._getstr(a,function(f){var g,h,i,j;return g=c.length,h=f.substring(0,b),j=f.substr(b+g),i=h+c+j,e.set(a,i,function(){return d(i.length)})})},a.prototype.strlen=function(a,b){return this._getstr(a,function(a){return b(a.length)})},a.prototype.ttl=function(a,b){return this._ttlmap(a,b,function(a){return Math.round(a/1e3)})},a.prototype.type=function(a,b){return this._checkttl(a,function(a){return null!=a?b(a.type):b("none")})},a}(),a.cmds=Object.keys(a.prototype).filter(function(a){return"_"!==a[0]}),b=function(){function a(){}return a.prototype._transaction=function(a,b){var c;return null==b&&(b="readwrite"),c=this.db.transaction(["keys","values"],b),c.onerror=function(b){return null!=a?a(b):void 0},c.onabort=function(){return null!=a?a(new Error("Transaction Aborted")):void 0},c},a}(),Dexdis=function(b){function Dexdis(){return d=Dexdis.__super__.constructor.apply(this,arguments)}var c,f,h,i,j;for(g(Dexdis,b),Dexdis.prototype._cmd=function(b,c,d,e){var f,g,h,i;g=null,h=function(a){g=a},i=this._transaction(d,e),i.oncomplete=function(){return null!=d?d(null,g):void 0},f=new a(i),f[b].apply(f,c.concat([h]))},Dexdis.prototype.select=function(a,b){var c,d=this;return"function"==typeof a&&(b=a,a=1),c=indexedDB.open(a,1),c.onupgradeneeded=function(){return a=c.result,a.createObjectStore("keys"),a.createObjectStore("values")},c.onsuccess=function(){return d.db=c.result,null!=b?b(null):void 0},c.onerror=function(){return b(c.error)},this},Dexdis.prototype.quit=function(a){return null!=this.db&&this.db.close(),null!=a&&a(null),this},Dexdis.prototype.multi=function(){return new DexdisTransaction(this.db)},j=a.cmds,f=function(a){return Dexdis.prototype[a]=function(){var b,c,d;return b=2<=arguments.length?e.call(arguments,0,d=arguments.length-1):(d=0,[]),c=arguments[d++],"function"==typeof c?this._cmd(a,b,c):(b=b.concat([c]),this._cmd(a,b,function(){})),this}},h=0,i=j.length;i>h;h++)c=j[h],f(c);return Dexdis}.call(this,b),DexdisTransaction=function(b){function DexdisTransaction(a){this.db=a,this.buffer=[]}var c,d,f,h,i;for(g(DexdisTransaction,b),DexdisTransaction.prototype._buffercmd=function(a,b){return this.buffer.push({cmd:a,args:b})},DexdisTransaction.prototype.exec=function(b){var c,d,e,f,g,h;g=this._transaction(b),d=new a(g),c=this.buffer,e=0,h=[],f=function(a){var b;return void 0!==a&&h.push(a),e++,e>c.length?void 0:(b=c[e-1],d[b.cmd].apply(d,b.args.concat([f])))},g.oncomplete=function(){return b(null,h)},g.onerror=function(a){return b(a)},f()},DexdisTransaction.prototype.discard=function(){return this.buffer=[],this.trans.abort()},i=a.cmds,d=function(a){return DexdisTransaction.prototype[a]=function(){var b;return b=1<=arguments.length?e.call(arguments,0):[],this._buffercmd(a,b),this}},f=0,h=i.length;h>f;f++)c=i[f],d(c);return DexdisTransaction}.call(this,b),Dexdis});